<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>logView</title>
    <link rel="stylesheet" th:href="@{/webjars/mdui/dist/css/mdui.css}">
    <script th:src="@{/webjars/jquery/jquery.min.js}"></script>
    <script th:src="@{/webjars/mdui/dist/js/mdui.js}"></script>
    <style>
        .wrong-border{
            border-top:1px solid #000000;
            border-bottom:1px solid #000000;}
        .keepline{
            width:auto;
            word-break:keep-all;
            white-space:nowrap;
        }
    </style>
</head>
<body class="mdui-theme-primary-indigo mdui-theme-accent-light-blue mdui-appbar-with-toolbar">
    <div class="mdui-container-fluid ">
        <div class="mdui-appbar mdui-shadow-0 mdui-appbar-fixed mdui-appbar-scroll-hide">
            <div class="mdui-toolbar mdui-color-black">
                <span class="mdui-typo-title mdui-text-color-white">日志查看器</span>
                <div class="mdui-toolbar-spacer"></div>
                <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent log-watch-btn" onclick="sendMessageToServer('watch')"><span class=" mdui-text-color-white log-watch-span">查看</span></button>
                <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" onclick="sendMessageToServer('pause')"><span class=" mdui-text-color-white log-pause-span">暂停</span></button>
                <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" onclick="clearMsg()"><span class=" mdui-text-color-white log-clear-span">清屏</span></button>

            </div>

        </div>
        <div class="mdui-panel" mdui-panel>
            <div class="mdui-panel-item">
                <div class="mdui-panel-item-header ">
                    <div class="mdui-panel-item-title">日志筛选项</div>
                    <i class="mdui-panel-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
                </div>
                <div class="mdui-panel-item-body">
                    <div id="ip-params" class="mdui-textfield mdui-col-xs-1 keepline">
                        <input class="mdui-textfield-input" type="text" placeholder="日志来源IP地址"/>
                    </div>
                    <div id="uri-params" class="mdui-textfield mdui-col-xs-1 keepline">
                        <input class="mdui-textfield-input" type="text" placeholder="URI"/>
                    </div>
                    <div id="bstp-params" class="mdui-textfield mdui-col-xs-1 keepline">
                        <input class="mdui-textfield-input" type="text" placeholder="bstp参数"/>
                    </div>
                    <div id="t-params" class="mdui-textfield mdui-col-xs-1 keepline">
                        <input class="mdui-textfield-input" type="text" placeholder="t参数"/>
                    </div>
                    <div id="rpage-params" class="mdui-textfield mdui-col-xs-1 keepline">
                        <input class="mdui-textfield-input" type="text" placeholder="rpage参数"/>
                    </div>
                    <div id="u-params" class="mdui-textfield mdui-col-xs-1 keepline">
                        <input class="mdui-textfield-input" type="text" placeholder="u参数"/>
                    </div>
                    <div class="mdui-panel-item-actions ">
                        <button id="filter-btn" class="mdui-btn mdui-ripple" onclick="sendMessageToServer('rewatch')">过滤一下</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mdui-container-fluid container_text">
        <div class="log-container">

        </div>
    </div>

    <script type="text/javascript" th:inline="javascript">

        function webSocket() {

            var webSocket = new WebSocket([[${webSocketUrl}]]);

            webSocket.onopen = function (ev) { console.log("建立webSocket连接"); };

            webSocket.onmessage = function (ev) {
                console.log("接收到Server端发来的消息");
                var data = JSON.parse(ev.data) || {};
                //console.log(data);
                var $messageContainer = $('.log-container');
                switch (data.type) {
                    //操作暂停按钮
                    case 0:
                        if (data.msg === '1') {
                            $('.log-pause-span').html('继续');
                        }else if (data.msg === '0'){
                            $('.log-pause-span').html('暂停');
                        }
                        break;
                    //有用的消息
                    case 1:
                        $('.log-watch-btn').hide();

                        $messageContainer.prepend('<div class="mdui-text-color-black-* keepline log-content" style="font-size:x-large">'+ data.msg +'</div>');
                        if ($messageContainer.children('div').length>320){
                            console.log("$messageContainer.children('div').length{}:",$messageContainer.children('div'));
                            $messageContainer.children(':last-child').remove();
                        }
                        break;
                    //错误的消息
                    case 2:
                        $('.log-watch-btn').hide();
                        var error = data.error;
                        $messageContainer.prepend('<div class="mdui-text-color-red-900 keepline wrong-border log-content" mdui-tooltip="{content:\''+error+'\'}" style="font-size:x-large">'+ data.msg +'</div>');
                        if ($messageContainer.children('div').length>320){
                            console.log("$messageContainer.children('div').length{}:",$messageContainer.children('div'));
                            $messageContainer.children(':last-child').remove();
                        }
                        break;
                    //清屏
                    case 3: clearMsg();break;
                    //筛选按钮可用
                    case 4: enableFilterBtn();
                        break;
                    default:break;
                }


            };

            webSocket.onclose = function (ev) { console.log("关闭webSocket连接"); };

            webSocket.onerror = function(ev) { console.log("webSocket通信异常",ev); };

            return webSocket;
        }

        var webSocket = webSocket();

        function sendMessageToServer(msg) {
            var ip = $('#ip-params > input').val();
            var uri = $('#uri-params > input').val();
            var bstp = $('#bstp-params > input').val();
            var t = $('#t-params > input').val();
            var rpage = $('#rpage-params > input').val();
            var u = $('#u-params > input').val();
            if (ip) {
                ip = ip.trim();
            }
            if (uri) {
                uri = uri.trim();
            }
            if (bstp) {
                bstp = bstp.trim();
            }
            if (t) {
                t = t.trim();
            }
            if (rpage) {
                rpage = rpage.trim();
            }
            if (u) {
                u = u.trim();
            }
            var filterParams = {ip:ip,uri:uri,bstp:bstp,t:t,rpage:rpage,u:u};
            console.log(filterParams);
            webSocket.send(JSON.stringify({msg:msg,params:filterParams}))
            $('#filter-btn').attr('disabled','disabled');
        }


        function clearMsg() {
            $('.log-container').empty();
        }

        function enableFilterBtn() {
            $('#filter-btn').removeAttr('disabled');
        }

        function isNull(str) {
            if ( str == "" ) {
                return true;
            }
            var regu = "^[ ]+$";
            var re = new RegExp(regu);
            return re.test(str);
        }

    </script>
</body>
</html>